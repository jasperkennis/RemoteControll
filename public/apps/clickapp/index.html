<!DOCTYPE html>
<html>
	<head>
		<title>Remotecontroll</title>
		<link href="/stylesheets/all.css?1314522841" media="screen" rel="stylesheet" type="text/css" />
		<script src="/javascripts/prototype.js?1309781076" type="text/javascript"></script>
		<script src="/javascripts/scriptaculous.js?1309960570" type="text/javascript"></script>
		<script src="http://js.pusherapp.com/1.9/pusher.min.js" type="text/javascript"></script>
		<script src="/javascripts/application.js?1314567656" type="text/javascript"></script>
	</head>
	<body id="screen_app_page">
		
		
		<script>
		
			var pusher_id = '7132d12d5d3ddf34b09e';
			var pusher_channel = 'myscreen-input';
		
			var Drawable = Class.create({
				initialize: function( size, position, direction, color, name, canvas){
					log("info", canvas);
					if(!self){ var self = this; }
					
					this.canvas = canvas;
					this.size = { w: size.w, h: size.h };
					this.position = { x: position.x, y: position.y };
					this.direction = { h: direction.h, v: direction.v }
					this.color = color;
					this.name = name;
					
					this.draw();
				},
				
				draw: function(){
					_canvas = this.canvas.getContext("2d");
					_canvas.fillStyle = "rgb(200,0,0)";
				},
				
				update: function(){
					this.position.x = this.position.x + this.direction.h;
					this.position.y = this.position.y + this.direction.v;
				}
			});
			
			var Bullet = Class.create(Drawable,{
				initialize: function($super, size, position, direction, color, name, canvas){
					$super.call(this, size, position, direction, color, name, canvas);
				},
				
				draw: function($super){
					$super();
					_canvas.beginPath();
					_canvas.arc(this.position.x, this.position.y, this.size.w/2, 0, Math.PI*2, true); 
					_canvas.closePath();
					_canvas.fill();
				}
			});
			
			
			
			var Player = Class.create(Drawable, {
				initialize: function($super, size, position, direction, color, name, canvas, id){
					$super.call(this, size, position, direction, color, name, canvas);
					this.fire_rate = 1;
					this.gun = new Gun();
					this.id = id;
				},
				
				draw: function($super){
					$super();
					_canvas.fillRect (this.position.x, this.position.y, this.size.w, this.size.h);
				},
				
				startShooting: function(){
					this.gun.startShooting();
				},
				
				stopShooting: function(){
					this.gun.stopShooting();
				}
			});
			
			
			
			var Gun = Class.create(PeriodicalExecuter,{
				initialize: function( $super, callback, fire_rate ) {
					
					if(!self){ var self = this; }
					
					this.frequency = 1;
					this.is_shooting = false;
					
					if( callback ){
						this.callback = callback;
					} else {
						this.callback = function(){
							if(this.is_shooting){
								var _bullet = new Bullet(
									{ h : 3 , w : 3 },
									{ x : 20 , y : 300 },
									{ h : 0 , v : -16 },
									"black",
									"bullet_time!",
									window.game.canvas
								);
							}
							
							window.game.bullets.push(_bullet);
							window.game.renderTickEngine.addDrawable(_bullet);
						}
					}
					$super.call(this, this.callback, this.frequency);
					this.stopShooting();
				},
				
				startShooting: function(){
					this.is_shooting = true;
				},
				
				stopShooting: function($super){
					this.is_shooting = false;
				}
			});



			var RenderTickEngine = Class.create(PeriodicalExecuter,{
				initialize: function( $super, callback, fps, canvas ) {
					this.frequency = 1/fps;
					this.canvas = canvas;
					this.drawables = new Array();
					
					if( callback ){
						this.callback = callback;
					} else {
						this.callback = function(){
							this.clearCanvas();
							this.updateDrawables();
							this.drawDrawables();
						}
					}
					$super.call(this, this.callback, this.frequency);
				},
				
				drawDrawables: function(){
					this.drawables.each(function(drawable){
						drawable.draw(this.canvas);
					});
				},
				
				updateDrawables: function(){
					this.drawables.each(function(drawable){
						drawable.update();
					});
				},
				
				addDrawable: function(drawable){
					if( !drawable ){
						log("error","Can't execute addDrawable if no drawable has been given.")
					} else {
						this.drawables.push(drawable);
					}
				},
				
				clearCanvas: function(){
					this.canvas.getContext("2d").clearRect(0,0,window.game.width,window.game.height);
				}
			});
		
			var Game = Class.create({
				initialize: function(){
					this.canvas = this.createCanvas("screen");
					this.bullets = new Array();
					this.renderTickEngine = new RenderTickEngine( null, 30, this.canvas );
					this.height = document.viewport.getHeight();
					this.width = document.viewport.getWidth();
				},
				
				createCanvas: function( id ){
					if(!self){ var self = this; } // Need this because the each iterator is going to overwrite this.
					
					_canvas = new Element( 'canvas' , {
						'id' : id,
						'width' : this.width,
						'height' : this.height
					});

					_canvas = document.body.appendChild(_canvas);
					
					return _canvas;
				}
			});
			
			var Connection = Class.create({
				initialize: function(id, channel){
		
					setPusher(id);
					setPusherChannel(channel);
				},
				
				onKeyDown: function(callback){
					getPusherChannel().bind('key-down', callback);
				},
				
				onKeyUp: function(callback){
					getPusherChannel().bind('key-up', callback);
				}
			});
			
			var PlayerController = Class.create({
				initialize: function(connection){
					
				}
			});
		
			document.observe("dom:loaded", function(){
				if( $('screen_app_page') != undefined ){
					
					var right_is_pressed = false;
					var left_is_pressed = false;
					var space_bar_is_pressed = false;
					
					connection = new Connection(pusher_id, pusher_channel);
					window.game = new Game();
					var player = new Player(
						{h: 20, w: 40},
						{x: 20, y: 15},
						{v: 0, h: 0},
						"black",
						"name",
						window.game.canvas
					);
					game.renderTickEngine.addDrawable(player);
					
					connection.onKeyDown(function(data){
						//data = data.evalJSON();
						switch (data.key) {
							case 37:
								if(!left_is_pressed){
									player.direction.h = player.direction.h - 2;
									left_is_pressed = true;
								}
								break;
							case 39:
								if(!right_is_pressed){
									player.direction.h =  player.direction.h + 2;
									right_is_pressed = true;
								}
								break;
							case 32:
								if(!space_bar_is_pressed) {
									player.startShooting();
									space_bar_is_pressed;
								}
								break;
						} 
					});
					
					connection.onKeyUp(function(data){
						//data = data.evalJSON();
						switch (data.key) {
							case 37:
								player.direction.h = player.direction.h + 2;
								left_is_pressed = false;
								break;
							case 39:
								player.direction.h =  player.direction.h - 2;
								right_is_pressed = false;
								break;
							case 32:
								player.stopShooting();
								space_bar_is_pressed;
						}
					});
				}
			});
		</script>
	</body>
</html>